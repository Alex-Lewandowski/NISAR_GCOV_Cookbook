#!/usr/bin/env bash
set -euxo pipefail

export PATH="${NB_PYTHON_PREFIX}/bin:${CONDA_DIR}/bin:${PATH}"
hash -r

echo "=== POSTBUILD START ==="
echo "NB_PYTHON_PREFIX=${NB_PYTHON_PREFIX:-<unset>}"
which python
python --version
which pixi
pixi --version

# Install/resolve your Pixi workspace (use lock if present)
cd "${REPO_DIR:-/home/jovyan}"
if [ -f pixi.lock ]; then
  pixi install --locked || pixi install
else
  pixi install
fi

# --- Register kernels for each Pixi env you need ---
pixi run -e isce3 -- python -m ipykernel install --user \
  --name "pixi-isce3" --display-name "Pixi (isce3)"

pixi run -e default -- python -m ipykernel install --user \
  --name "pixi-python3" --display-name "Pixi Python 3 (default)"

echo "=== INSTALLED KERNELS ==="
jupyter kernelspec list
